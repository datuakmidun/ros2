# =============================================================================
# KRSBI-B Soccer Robot - Kalman Filter Configuration
# =============================================================================
# Kalman filter parameters for ball and robot tracking
# =============================================================================

# -----------------------------------------------------------------------------
# Ball Tracking Kalman Filter
# -----------------------------------------------------------------------------
ball_tracker:
  enabled: true

  # State vector: [x, y, vx, vy, ax, ay]
  # Using constant acceleration model for ball
  model: "constant_acceleration"

  # Process noise (Q matrix)
  # Higher values = more trust in measurements
  process_noise:
    position: 0.1 # Position variance
    velocity: 1.0 # Velocity variance
    acceleration: 5.0 # Acceleration variance

  # Measurement noise (R matrix)
  # Lower values = more trust in measurements
  measurement_noise:
    position: 2.0 # Pixel position variance

  # Initial covariance (P matrix)
  initial_covariance:
    position: 100.0
    velocity: 50.0
    acceleration: 10.0

  # Prediction parameters
  prediction:
    max_prediction_time: 1.0 # seconds (for ball trajectory)
    prediction_dt: 0.02 # 50 Hz prediction

  # Track management
  track:
    confirmation_threshold: 3 # Hits before confirmed
    deletion_threshold: 10 # Misses before deleted
    max_age: 30 # Max frames without detection
    min_hits: 3 # Min detections to be valid

  # Gating (association)
  gating:
    distance_threshold: 100 # Max pixels for association
    use_mahalanobis: true # Use Mahalanobis distance
    mahalanobis_threshold: 9.21 # Chi-squared 95% (2 DoF)

  # Ball physics
  physics:
    enabled: true
    friction: 0.3 # Rolling friction coefficient
    max_velocity: 3.0 # m/s (reasonable ball speed)
    bounce_decay: 0.7 # Velocity retained after bounce

# -----------------------------------------------------------------------------
# Robot Tracking Kalman Filter
# -----------------------------------------------------------------------------
robot_tracker:
  enabled: true

  # State vector: [x, y, vx, vy]
  # Using constant velocity model for robots
  model: "constant_velocity"

  # Process noise
  process_noise:
    position: 0.5
    velocity: 2.0

  # Measurement noise
  measurement_noise:
    position: 5.0

  # Initial covariance
  initial_covariance:
    position: 200.0
    velocity: 100.0

  # Track management
  track:
    confirmation_threshold: 5
    deletion_threshold: 15
    max_age: 50
    min_hits: 5

  # Gating
  gating:
    distance_threshold: 150
    use_mahalanobis: true
    mahalanobis_threshold: 11.07 # Chi-squared 95% (3 DoF)

# -----------------------------------------------------------------------------
# Multi-Object Tracking
# -----------------------------------------------------------------------------
multi_object:
  # Association algorithm
  association: "hungarian" # "hungarian", "greedy", "iou"

  # IOU-based association
  iou:
    min_iou: 0.3 # Minimum IOU for association

  # Feature-based association
  feature:
    enabled: false
    descriptor: "color_histogram"
    similarity_threshold: 0.5

  # Track ID management
  next_id_start: 1
  max_track_id: 10000 # Reset after this

# -----------------------------------------------------------------------------
# Sensor Fusion
# -----------------------------------------------------------------------------
fusion:
  enabled: true

  # Combine detections from multiple cameras
  cameras:
    - front_camera
    - omni_camera

  # Fusion method
  method: "weighted_average" # "weighted_average", "kalman", "covariance"

  # Camera weights (based on reliability)
  weights:
    front_camera: 0.6 # Higher weight for direct view
    omni_camera: 0.4

  # Time synchronization
  max_time_diff: 0.1 # seconds

  # Position fusion in world coordinates
  world_frame: true # Transform to world frame before fusion

# -----------------------------------------------------------------------------
# Prediction (for lost ball)
# -----------------------------------------------------------------------------
prediction:
  enabled: true

  # Maximum prediction duration
  max_duration: 2.0 # seconds

  # Update rate
  update_rate: 50 # Hz

  # Confidence decay
  confidence_decay: 0.1 # Per prediction step
  min_confidence: 0.1

  # Physics-based prediction
  physics:
    gravity: 0.0 # 2D, no gravity
    friction: 0.3
    air_resistance: 0.01
